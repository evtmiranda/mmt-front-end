@{
    ViewBag.Title = "resumo pedido";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="col-md-3"></div>
            <div class="col-md-6 resumo-pedido" style="text-align: center">
                <h1>resumo do pedido</h1>
                <hr />
                <h3>pedido</h3>

                @* exibe os detalhes do pedido *@
                @if (Session["Carrinho"] != null)
                {
                    decimal valorTotalPedido = 0;

                    foreach (ClassesMarmitex.ProdutoPedido p in (List<ClassesMarmitex.ProdutoPedido>)Session["Carrinho"])
                    {
                        //se o produto tiver itens adicionais
                        if (p.Produto.DadosAdicionaisProdutos.Sum(adicional => adicional.ItensAdicionais.Sum(item => item.Qtd)) > 0)
                        {
                            <p><strong>@p.Produto.Nome</strong></p>
                            foreach (var adicional in p.Produto.DadosAdicionaisProdutos)
                            {
                                foreach (var item in adicional.ItensAdicionais)
                                {
                                    if (item.Qtd > 0)
                                    {
                                        <small>@item.Nome @item.Qtd</small><br />
                                    }
                                }
                            }
                        }
                        else
                        {
                            //exibe os produtos e a quantidade
                            <p><strong>@p.Quantidade @p.Produto.Nome R$ @p.ValorTotal </strong></p>
                        }

                        { valorTotalPedido += p.ValorTotal; }
                    }

                    <h3>horário de entrega</h3>
                    if (Session["HorarioEntrega"] != null)
                    {
                        <p>as @Session["HorarioEntrega"] horas</p>
                    }

                    <h3>formas de pagamento</h3>
                    if (Session["FormaPagamento"] != null)
                    {
                        foreach (var formaPagamento in (List<string>)Session["FormaPagamento"])
                        {
                            <p>@formaPagamento</p>
                        }
                    }

                    if (Session["ValorTroco"] != null)
                    {
                        <p>R$ @Session["ValorTroco"] de troco</p>
                    }

                    if (Session["Observacao"] != null)
                    {
                        <h3>observações</h3>
                        <p>@Session["Observacao"]</p>
                    }

                    <h3>valor total do pedido</h3>
                    <p>R$ @valorTotalPedido</p>

                    <br />

                    //monta o pedido
                    ClassesMarmitex.Pedido pedidoFinal = new ClassesMarmitex.Pedido();
                    pedidoFinal.Cliente = (ClassesMarmitex.UsuarioParceiro)Session["UsuarioLogado"];
                    pedidoFinal.ListaProdutos = (List<ClassesMarmitex.ProdutoPedido>)Session["Carrinho"];
                    pedidoFinal.HorarioEntrega = (string)Session["HorarioEntrega"];

                    //monta as formas de pagamento
                    List<ClassesMarmitex.FormaDePagamento> pagamentos = new List<ClassesMarmitex.FormaDePagamento>();
                    foreach (var formaPagamento in (List<string>)Session["FormaPagamento"])
                    {
                        pagamentos.Add(new ClassesMarmitex.FormaDePagamento { Nome = formaPagamento });
                    }

                    pedidoFinal.ListaFormaPagamento = pagamentos;

                    pedidoFinal.Troco = Session["ValorTroco"] != null ? Session["ValorTroco"].ToString() : "";

                    pedidoFinal.Observacao = @Session["Observacao"] != null ? (string)@Session["Observacao"] : "";


                    //objeto para realizar um post com ajax e atualizar o conteudo de uma determinada div
                    ClassesMarmitex.DadosPostAjax postAjax = new ClassesMarmitex.DadosPostAjax();
                    postAjax.Recurso = "/ResumoPedido/ConfirmarPedido";

                    string ConfirmarPedido = string.Format("ConfirmarPedido('{0}', '{1}', '{2}', '{3}')", @Html.Raw(Json.Encode(@postAjax)), @Html.Raw(Json.Encode(pedidoFinal)), @Session["urlBase"], "/DetalhesPedido/PedidoConcluido");

                    <a href="@Session["urlBase"]/DetalhesPedido" class="btn btn-amarelo-sem-animacao" role="button">editar</a>
                    <a href="#" onclick="@ConfirmarPedido" class="btn btn-vermelho-sem-animacao" role="button">confirmar</a>

                    if(Session["MensagemCadastroPedido"] != null)
                    {
                        <div style="margin-top: 10px">
                            <p class="vermelho-marmitex">@Session["MensagemCadastroPedido"]</p>
                            <a href="#">ir para histórico de pedidos</a>
                        </div>
                    }
                }
            </div>
            <div class="col-md-3"></div>
        </div>
    </div>
</div>
